<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Arduino Angle Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <style>
      body { font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial; margin: 0; padding: 0; color: #111; background: #f9f9f9 }
      header { background: #0b69ff; color: white; padding: 12px 20px }
      main { padding: 20px; max-width: 1400px; margin: 0 auto }
      h1,h2 { margin: 0 0 8px 0 }
      section { background: white; margin-bottom: 20px; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1) }
      #controls { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; flex-wrap: wrap }
      input { padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px }
      button { padding: 6px 12px; background: #0b69ff; color: white; border: none; border-radius: 4px; cursor: pointer }
      button:hover { background: #0a5ae6 }
      table { border-collapse: collapse; width: 100%; max-width: 400px; margin-top: 8px }
      th, td { padding: 6px 8px; border: 1px solid #ddd; text-align: right }
      th { background: #f3f4f6; text-align: left }
      #content { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start }
      .panel { flex: 1; min-width: 300px }
      #chart-container { width: 100%; height: 300px }
      #three-container { width: 100%; height: 300px; background: #eef; border-radius: 4px }
    </style>
  </head>
  <body>
    <header>
      <h1>Arduino Incline Angle Visualizer</h1>
    </header>
    <main>
      <section>
        <h2>Inclination Angle Measurement</h2>
        <div id="controls">
          <label>CSV File URL:<br/><input id="csvUrl" type="text" value="data/angles.csv" style="width:250px" /></label>
          <button onclick="loadCSV()">Load Data</button>
        </div>
        <p id="status">Ready. Enter CSV path or URL and click Load Data.</p>
      </section>

      <div id="content">
        <div class="panel">
          <h3>Raw Angle Data</h3>
          <table>
            <thead><tr><th>#</th><th>ax (°)</th><th>ay (°)</th><th>az (°)</th></tr></thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>
        <div class="panel">
          <h3>Angle Plot</h3>
          <div id="chart-container"><canvas id="chart"></canvas></div>
        </div>
        <div class="panel">
          <h3>3D Airplane (Live)</h3>
          <div id="three-container"></div>
        </div>
      </div>
    </main>

    <script>
      let chart = null;
      let scene, camera, renderer, airplane;
      let allData = [];

      async function loadCSV() {
        const url = document.getElementById('csvUrl').value.trim();
        if (!url) return alert('Enter CSV URL');
        try {
          document.getElementById('status').textContent = 'Loading...';
          const resp = await fetch(url);
          const text = await resp.text();
          const lines = text.split(/\r?\n/).filter(l => l.trim());
          allData = lines.map(line => {
            const parts = line.split(',').map(s => s.trim());
            const ax = parseFloat(parts[0]) || 0;
            const ay = parseFloat(parts[1]) || 0;
            const az = parseFloat(parts[2]) || 0;
            return { ax, ay, az };
          }).filter(d => !isNaN(d.ax) || !isNaN(d.ay) || !isNaN(d.az));

          if (allData.length === 0) throw new Error('No valid data found');
          document.getElementById('status').textContent = `Loaded ${allData.length} samples`;
          renderTable();
          initChart();
          updateChart();
          if (!airplane) initThree();
        } catch (e) {
          document.getElementById('status').textContent = `Error: ${e.message}`;
          console.error(e);
        }
      }

      function renderTable() {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        allData.slice(-20).forEach((row, i) => {
          const tr = document.createElement('tr');
          [i+1, row.ax.toFixed(2), row.ay.toFixed(2), row.az.toFixed(2)].forEach(v => {
            const td = document.createElement('td');
            td.textContent = v;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }

      function initChart() {
        const ctx = document.getElementById('chart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'line',
          data: { labels: [], datasets: [
            { label: 'ax', borderColor: '#1f77b4', data: [], fill: false },
            { label: 'ay', borderColor: '#ff7f0e', data: [], fill: false },
            { label: 'az', borderColor: '#2ca02c', data: [], fill: false }
          ] },
          options: { animation: false, responsive: true, plugins: { legend: { position: 'top' } }, scales: { x: { display: true }, y: { display: true } } }
        });
      }

      function updateChart() {
        if (!chart) return;
        chart.data.labels = allData.map((_, i) => i+1);
        chart.data.datasets[0].data = allData.map(d => d.ax);
        chart.data.datasets[1].data = allData.map(d => d.ay);
        chart.data.datasets[2].data = allData.map(d => d.az);
        chart.update('none');
      }

      function initThree() {
        const container = document.getElementById('three-container');
        const width = container.clientWidth;
        const height = container.clientHeight;
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        container.innerHTML = '';
        container.appendChild(renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 10, 7);
        scene.add(light);

        airplane = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.3, 0.3), new THREE.MeshStandardMaterial({ color: 0x5555ff }));
        airplane.add(body);
        const wing = new THREE.Mesh(new THREE.BoxGeometry(0.1, 2.0, 0.6), new THREE.MeshStandardMaterial({ color: 0x333 }));
        airplane.add(wing);
        const tail = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.6, 0.4), new THREE.MeshStandardMaterial({ color: 0x5555ff }));
        tail.position.set(-0.8, 0.2, 0);
        airplane.add(tail);

        scene.add(airplane);
        camera.position.set(0, 3, 5);
        camera.lookAt(0, 0, 0);

        function animate() {
          requestAnimationFrame(animate);
          renderer.render(scene, camera);
        }
        animate();
      }

      function applyAngles() {
        if (!airplane || allData.length === 0) return;
        const latest = allData[allData.length - 1];
        airplane.rotation.x = (latest.ax || 0) * Math.PI / 180;
        airplane.rotation.y = (latest.ay || 0) * Math.PI / 180;
        airplane.rotation.z = (latest.az || 0) * Math.PI / 180;
      }

      // Auto-animate airplane through data
      let idx = 0;
      setInterval(() => {
        if (allData.length === 0) return;
        idx = (idx + 1) % allData.length;
        if (airplane) applyAngles();
      }, 200);

      // Load on Enter key
      document.getElementById('csvUrl').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadCSV();
      });
    </script>
  </body>
</html>
